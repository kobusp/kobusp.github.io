(()=>{const e=document.getElementById("complaint-form"),t=document.getElementById("output-surface"),n=document.getElementById("form-template"),a=document.getElementById("download-pdf"),s=document.getElementById("reset-form"),o=document.getElementById("use-location"),i=document.getElementById("location-status"),l=document.getElementById("signature-canvas"),r=document.getElementById("clear-signature"),d=document.getElementById("lookup-complainant-address"),c=document.getElementById("complainant-address-status"),m=document.getElementById("lookup-suspect-address"),u=document.getElementById("suspect-address-status"),g=document.getElementById("open-map"),p=document.getElementById("close-map"),h=document.getElementById("confirm-map"),y=document.getElementById("map-modal"),v=document.getElementById("map-status"),f=document.getElementById("map-style-satellite"),b=document.getElementById("map-style-streets"),C=document.getElementById("copy-emails"),E=document.getElementById("email-list"),x=document.getElementById("copy-status"),L=n.content.firstElementChild.cloneNode(!0);t.appendChild(L);const w=new SignaturePad(l,{backgroundColor:"rgba(255, 255, 255, 0)",penColor:"#0b1c4a",minWidth:2.5,maxWidth:4.5}),P=window.matchMedia("(max-width: 700px)"),k=()=>{const e=P.matches;w.minWidth=e?1.25:2.5,w.maxWidth=e?2.25:4.5},I=()=>{const e=Math.max(window.devicePixelRatio||1,1),{offsetWidth:t,offsetHeight:n}=l;l.width=Math.floor(t*e),l.height=Math.floor(n*e),l.getContext("2d").setTransform(e,0,0,e,0,0),w.clear()};k(),I(),P.addEventListener("change",k),window.addEventListener("resize",I);const A=(e=>{const t=new Map;return e.querySelectorAll("[data-bind]").forEach(e=>{t.set(e.dataset.bind,e)}),t})(L),B=(e=>{const t=new Map;return e.querySelectorAll("[data-bind-line]").forEach(e=>{const[n,a]=e.dataset.bindLine.split(":"),s=t.get(n)||[];s[Number(a)]=e,t.set(n,s)}),t})(L),S=(e=>{const t=new Map;return e.querySelectorAll("[data-bind-image]").forEach(e=>{t.set(e.dataset.bindImage,e)}),t})(L),M=(e,t)=>{const n=A.get(e);n&&(n.textContent=t||"")},N=(e,t,n)=>{const a=(t||"").split(/\r?\n/).flatMap(e=>{const t=e.split(/\s+/).filter(Boolean),n=[];let a="";return t.forEach(e=>{const t=a?`${a} ${e}`:e;t.length>130?(n.push(a),a=e):a=t}),a&&n.push(a),n}).slice(0,n),s=B.get(e)||[];for(let e=0;e<n;e+=1)s[e]&&(s[e].textContent=a[e]||"")},T=(e,t)=>{const n=S.get(e);n&&(n.src=t||"")},$=e=>{M("suspectTypePrivate","Private"===e?"X":""),M("suspectTypeCompany","Company"===e?"X":"")},W=()=>{const e=(new Date).toLocaleDateString("en-ZA",{year:"numeric",month:"short",day:"2-digit"});M("signatureDate",e)},F=(e,t)=>[e,t].filter(Boolean).join(", "),D=(e,t,n,a)=>[e,t,n,a].filter(Boolean).join(", "),O=()=>{const t=e.elements.complainantAddressLine1.value.trim(),n=e.elements.complainantAddressLine2.value.trim(),a=e.elements.complainantSuburb.value.trim(),s=e.elements.complainantCityName.value.trim(),o=e.elements.complainantProvince.value.trim(),i=e.elements.complainantPostalCode.value.trim();M("complainantAddress",F(t,n)),M("complainantCity",D(a,s,o,i))},X=()=>{const t=e.elements.suspectAddressLine1.value.trim(),n=e.elements.suspectAddressLine2.value.trim(),a=e.elements.suspectSuburb.value.trim(),s=e.elements.suspectCityName.value.trim(),o=e.elements.suspectProvince.value.trim(),i=e.elements.suspectPostalCode.value.trim();M("suspectAddress",F(t,n)),M("suspectCity",D(a,s,o,i))},j=window.MAPBOX_TOKEN||"pk.eyJ1Ijoia29idXNwcmV0IiwiYSI6ImNtbGtkbHllczA4c2szZHF4dG5oZjFnbHIifQ.F2Nv5qUKMUfh-M10jmDB6Q",_={satellite:"mapbox://styles/mapbox/satellite-streets-v12",streets:"mapbox://styles/mapbox/streets-v12"};let R,U,z,H="satellite";const Y=()=>{y.classList.remove("is-open"),y.setAttribute("aria-hidden","true")},q=e=>{R&&_[e]&&(H=e,(e=>{f.classList.toggle("is-active","satellite"===e),b.classList.toggle("is-active","streets"===e)})(e),R.setStyle(_[e]),R.once("styledata",()=>{z&&(U?U.setLngLat([z.lng,z.lat]):U=(new mapboxgl.Marker).setLngLat([z.lng,z.lat]).addTo(R))}))},G=e=>{R&&e&&(R.flyTo({center:[e.lng,e.lat],zoom:15}),U?U.setLngLat([e.lng,e.lat]):U=(new mapboxgl.Marker).setLngLat([e.lng,e.lat]).addTo(R),z=e,v.textContent=`Selected: ${e.lat.toFixed(6)}, ${e.lng.toFixed(6)}`)},K=(e,t)=>{const n=e?.find(e=>e.id?.startsWith(`${t}.`));return n?.text||""},V=async(t,n)=>{navigator.geolocation?(t.textContent="Fetching location...",navigator.geolocation.getCurrentPosition(async a=>{try{const s=await(async(e,t)=>{if(!j||"YOUR_MAPBOX_ACCESS_TOKEN"===j)throw new Error("Missing Mapbox token");const n=new URL(`https://api.mapbox.com/geocoding/v5/mapbox.places/${t},${e}.json`);n.searchParams.set("access_token",j),n.searchParams.set("types","address,neighborhood,locality,place,district,region,postcode"),n.searchParams.set("language","en");const a=await fetch(n.toString());if(!a.ok)throw new Error("Reverse geocoding failed");return a.json()})(a.coords.latitude,a.coords.longitude);((t,n)=>{const a=n.features||[],s=a.find(e=>e.place_type?.includes("address"))||a[0],o=s?.context||[],i=s?.text||"",l=s?.address||"",r=K(o,"neighborhood"),d=K(o,"locality"),c=K(o,"place"),m=K(o,"district"),u=K(o,"region"),g=K(o,"postcode"),p=[l,i].filter(Boolean).join(" ").trim(),h=[r,d,m].filter(Boolean).join(", "),y=r||m,v=c||d,f=u;e.elements[`${t}AddressLine1`].value=p,e.elements[`${t}AddressLine2`].value=h,e.elements[`${t}Suburb`].value=y,e.elements[`${t}CityName`].value=v,e.elements[`${t}Province`].value=f,e.elements[`${t}PostalCode`].value=g})(n,s),"complainant"===n?O():X(),t.textContent="Address filled. Please verify the details."}catch(e){t.textContent="Missing Mapbox token"===e.message?"Mapbox token missing. Please add it to enable lookup.":"Unable to fetch address. Please enter it manually."}},()=>{t.textContent="Unable to fetch location. Please enter it manually."},{enableHighAccuracy:!0,timeout:1e4})):t.textContent="Geolocation is not supported on this device."},Z=()=>{const t=new FormData(e);t.forEach((e,t)=>{M(t,e.toString())}),$(t.get("suspectType")),O(),X(),N("transgressionAddress",t.get("transgressionAddress"),4),N("transgressionDetails",t.get("transgressionDetails"),4),N("transgressionSite",t.get("transgressionSite"),2),N("additionalInfo",t.get("additionalInfo"),5),W()},Q=()=>{w.isEmpty()?T("signature",""):T("signature",w.toDataURL("image/png"))};e.addEventListener("input",e=>{const{name:t,value:n}=e.target;t&&("transgressionAddress"!==t?"transgressionDetails"!==t?"transgressionSite"!==t?"additionalInfo"!==t?t.startsWith("complainantAddress")||t.startsWith("complainantSuburb")||t.startsWith("complainantCityName")||t.startsWith("complainantProvince")||t.startsWith("complainantPostalCode")?O():t.startsWith("suspectAddress")||t.startsWith("suspectSuburb")||t.startsWith("suspectCityName")||t.startsWith("suspectProvince")||t.startsWith("suspectPostalCode")?X():("suspectType"===t&&$(n),M(t,n)):N("additionalInfo",n,4):N("transgressionSite",n,2):N("transgressionDetails",n,4):N("transgressionAddress",n,4))}),e.addEventListener("change",Z),w.addEventListener("endStroke",Q),r.addEventListener("click",()=>{w.clear(),Q()}),o.addEventListener("click",()=>{navigator.geolocation?(i.textContent="Fetching location...",navigator.geolocation.getCurrentPosition(t=>{const n=`${t.coords.latitude.toFixed(6)}, ${t.coords.longitude.toFixed(6)}`;e.elements.transgressionCoords.value=n,M("transgressionCoords",n),i.textContent="Location added. You can edit the coordinates if needed."},()=>{i.textContent="Unable to fetch location. Please enter it manually."},{enableHighAccuracy:!0,timeout:1e4})):i.textContent="Geolocation is not supported on this device."}),s.addEventListener("click",()=>{w.clear(),Z()}),a.addEventListener("click",async()=>{if(!(["complainantName","complainantSurname","complainantAddressLine1","complainantEmail","complainantMobile","signatureName"].filter(t=>!e.elements[t].value.trim()).length?(alert("Please complete the required fields before downloading."),0):!w.isEmpty()||(alert("Please add your signature before downloading."),0)))return;Z(),Q();const n=(await html2canvas(t,{scale:2,useCORS:!0,backgroundColor:"#ffffff"})).toDataURL("image/png"),a=new window.jspdf.jsPDF({orientation:"portrait",unit:"pt",format:"a4"}),s=a.internal.pageSize.getWidth(),o=a.internal.pageSize.getHeight();a.addImage(n,"PNG",0,0,s,o),a.save("environmental-complaint-form.pdf")}),Z(),W(),d.addEventListener("click",()=>V(c,"complainant")),m.addEventListener("click",()=>V(u,"suspect")),g.addEventListener("click",()=>{if(!j||"YOUR_MAPBOX_ACCESS_TOKEN"===j)return void(i.textContent="Mapbox token missing. Please add it to enable the map.");y.classList.add("is-open"),y.setAttribute("aria-hidden","false"),!R&&window.mapboxgl&&(mapboxgl.accessToken=j,R=new mapboxgl.Map({container:"map",style:_[H],center:[28.0473,-26.2041],zoom:10}),R.on("click",e=>{const{lng:t,lat:n}=e.lngLat;z={lat:n,lng:t},U?U.setLngLat([t,n]):U=(new mapboxgl.Marker).setLngLat([t,n]).addTo(R),v.textContent=`Selected: ${n.toFixed(6)}, ${t.toFixed(6)}`}));const t=(e=>{if(!e)return null;const t=e.split(",").map(e=>e.trim());if(2!==t.length)return null;const n=Number(t[0]),a=Number(t[1]);return Number.isFinite(n)&&Number.isFinite(a)?{lat:n,lng:a}:null})(e.elements.transgressionCoords.value);t&&(z=t),R&&setTimeout(()=>{R.resize(),t?G(t):navigator.geolocation&&R&&navigator.geolocation.getCurrentPosition(e=>{G({lat:e.coords.latitude,lng:e.coords.longitude})},()=>{v.textContent="Tap the map to drop a pin."},{enableHighAccuracy:!0,timeout:1e4})},200)}),p.addEventListener("click",Y),y.addEventListener("click",e=>{e.target===y&&Y()}),h.addEventListener("click",()=>{(()=>{if(!z)return v.textContent="Please tap the map to drop a pin.",!1;const t=`${z.lat.toFixed(6)}, ${z.lng.toFixed(6)}`;return e.elements.transgressionCoords.value=t,M("transgressionCoords",t),i.textContent="Map location applied. You can edit the coordinates if needed.",!0})()&&Y()}),f.addEventListener("click",()=>q("satellite")),b.addEventListener("click",()=>q("streets")),C&&C.addEventListener("click",async()=>{if(!E)return;const e=E.value.trim();if(e){try{await navigator.clipboard.writeText(e),x.textContent="Copied!"}catch(e){E.select(),document.execCommand("copy"),x.textContent="Copied!"}setTimeout(()=>{x.textContent="Tap Copy to copy all addresses."},2e3)}})})();
